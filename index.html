<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プログラミング復習ノート</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
        }

        .code-font {
            font-family: 'JetBrains Mono', monospace;
        }

        .code-area {
            background-color: #1e293b;
            color: #e2e8f0;
            resize: none;
            line-height: 1.6;
        }

        .code-area:focus {
            outline: 2px solid #3b82f6;
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Code Reviewer</h1>
                <p class="text-slate-500">間違いを正解に変える、あなたのための復習ノート</p>
            </div>
            <div class="flex gap-2">
                <button onclick="createNew()" class="px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition shadow-sm">
                    <i class="fas fa-plus mr-2"></i>新規作成
                </button>
                <button onclick="saveEntry()" id="saveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md flex items-center">
                    <i class="fas fa-save mr-2"></i>保存する
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left Sidebar: History -->
            <aside class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 h-[calc(100vh-200px)] flex flex-col">
                    <h2 class="font-bold text-slate-800 mb-4 flex items-center">
                        <i class="fas fa-history mr-2 text-blue-500"></i>履歴
                    </h2>
                    <div id="historyList" class="flex-1 overflow-y-auto space-y-2">
                        <!-- History items will be injected here -->
                        <div class="text-center py-8 text-slate-400 text-sm">読み込み中...</div>
                    </div>
                </div>
            </aside>

            <!-- Main Workspace -->
            <main class="lg:col-span-3 space-y-6">
                <!-- Title & Meta -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-700 mb-1">タイトル</label>
                            <input type="text" id="entryTitle" placeholder="タイトルを入力するか、AIで生成..." class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </div>
                        <button onclick="generateTitleFromAI()" id="aiGenBtn" class="px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition flex items-center h-[42px]">
                            <i class="fas fa-magic mr-2"></i>タイトルを自動生成
                        </button>
                    </div>
                </div>

                <!-- Code Editors -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-[500px]">
                    <!-- Mistake Block -->
                    <div class="flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-4 py-2 bg-red-50 border-b border-red-100 flex items-center justify-between">
                            <span class="text-red-700 font-bold text-sm"><i class="fas fa-times-circle mr-1"></i>Mistake (自分のコード)</span>
                        </div>
                        <textarea id="mistakeCode" class="flex-1 p-4 code-area code-font text-sm" placeholder="// ここに間違ったコードを貼り付けてください..."></textarea>
                    </div>

                    <!-- Correct Block -->
                    <div class="flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-4 py-2 bg-green-50 border-b border-green-100 flex items-center justify-between">
                            <span class="text-green-700 font-bold text-sm"><i class="fas fa-check-circle mr-1"></i>Success (正解のコード)</span>
                        </div>
                        <textarea id="correctCode" class="flex-1 p-4 code-area code-font text-sm" placeholder="// ここに正しいコードを貼り付けてください..."></textarea>
                    </div>
                </div>

                <!-- Notes -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <label class="block text-sm font-medium text-slate-700 mb-1">学習メモ・修正のポイント</label>
                    <textarea id="notes" rows="3" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="どこが原因だったか、何を学んだかをメモしましょう..."></textarea>
                </div>
            </main>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl z-50">
        メッセージ
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, addDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'code-reviewer-app';
        const apiKey = ""; // Gemini API Key

        let currentUser = null;
        let currentEntryId = null;
        let entries = [];

        // UI Helpers
        const showToast = (msg) => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        };

        // Firebase Auth initialization
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadHistory();
            }
        });

        // Firestore Logic
        const loadHistory = () => {
            if (!currentUser) return;
            
            const entriesRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'entries');
            
            // Note: Simple query to avoid complex indexes
            onSnapshot(entriesRef, (snapshot) => {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort by date in memory
                entries.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds);

                if (entries.length === 0) {
                    historyList.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">履歴はありません</div>';
                    return;
                }

                entries.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = `p-3 rounded-lg border cursor-pointer transition flex justify-between items-center ${currentEntryId === entry.id ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-100 hover:bg-slate-100'}`;
                    item.innerHTML = `
                        <div class="truncate flex-1" onclick="selectEntry('${entry.id}')">
                            <p class="font-medium text-slate-800 truncate">${entry.title || '無題のメモ'}</p>
                            <p class="text-[10px] text-slate-400">${entry.createdAt?.toDate().toLocaleString() || ''}</p>
                        </div>
                        <button onclick="deleteEntry('${entry.id}')" class="text-slate-300 hover:text-red-500 ml-2">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    `;
                    historyList.appendChild(item);
                });
            }, (error) => {
                console.error("Snapshot error:", error);
                showToast("データの読み込みに失敗しました");
            });
        };

        window.selectEntry = (id) => {
            currentEntryId = id;
            const entry = entries.find(e => e.id === id);
            if (entry) {
                document.getElementById('entryTitle').value = entry.title || '';
                document.getElementById('mistakeCode').value = entry.mistakeCode || '';
                document.getElementById('correctCode').value = entry.correctCode || '';
                document.getElementById('notes').value = entry.notes || '';
            }
            loadHistory(); // Refresh highlighting
        };

        window.saveEntry = async () => {
            if (!currentUser) return;
            
            const title = document.getElementById('entryTitle').value || '無題のメモ';
            const mistakeCode = document.getElementById('mistakeCode').value;
            const correctCode = document.getElementById('correctCode').value;
            const notes = document.getElementById('notes').value;

            if (!mistakeCode && !correctCode) {
                showToast("コードを入力してください");
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="loading-spinner mr-2"></div>保存中...';

            try {
                const data = {
                    title,
                    mistakeCode,
                    correctCode,
                    notes,
                    updatedAt: Timestamp.now()
                };

                if (currentEntryId) {
                    await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'entries', currentEntryId), data, { merge: true });
                } else {
                    data.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'entries'), data);
                    currentEntryId = docRef.id;
                }
                showToast("保存しました！");
            } catch (error) {
                console.error("Save error:", error);
                showToast("保存に失敗しました");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>保存する';
            }
        };

        window.deleteEntry = async (id) => {
            if (!confirm("この記録を削除してもよろしいですか？")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'entries', id));
                if (currentEntryId === id) createNew();
                showToast("削除しました");
            } catch (e) {
                showToast("削除に失敗しました");
            }
        };

        window.createNew = () => {
            currentEntryId = null;
            document.getElementById('entryTitle').value = '';
            document.getElementById('mistakeCode').value = '';
            document.getElementById('correctCode').value = '';
            document.getElementById('notes').value = '';
            loadHistory();
        };

        // Gemini API for Title Generation
        window.generateTitleFromAI = async () => {
            const mistake = document.getElementById('mistakeCode').value;
            const correct = document.getElementById('correctCode').value;

            if (!mistake && !correct) {
                showToast("コードを先に入力してください");
                return;
            }

            const aiBtn = document.getElementById('aiGenBtn');
            aiBtn.disabled = true;
            aiBtn.innerHTML = '<div class="loading-spinner mr-2"></div>AI分析中...';

            const prompt = `以下の「間違いコード」と「正解コード」を比較し、このプログラミングの学習内容を要約した短いタイトル（15文字以内）を1つだけ出力してください。
            間違い: ${mistake.substring(0, 500)}
            正解: ${correct.substring(0, 500)}`;

            const systemPrompt = "あなたはプログラミング講師です。学習者のコードを分析し、何についての修正かを示す簡潔なタイトルを日本語で作成してください。余計な説明は省き、タイトルのみを出力してください。";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const result = await response.json();
                const aiTitle = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "復習ノート";
                document.getElementById('entryTitle').value = aiTitle.replace(/["'「」]/g, '');
                showToast("タイトルを生成しました");
            } catch (error) {
                console.error("AI Generation failed:", error);
                showToast("タイトルの生成に失敗しました");
            } finally {
                aiBtn.disabled = false;
                aiBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>タイトルを自動生成';
            }
        };
    </script>
</body>
</html>
